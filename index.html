<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarGram</title>
    <script async src="https://telegram.org/js/telegram-web-app.js"></script>
    <script async src="https://api.kvstore.io/js/public.js?storage_uuid=f59366b9-b84a-48ae-9343-b50a15975986"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--tg-theme-bg-color);
        color: var(--tg-theme-text-color);
      }

      .container {
        padding: 16px;
      }

      h1, h2 {
        color: var(--tg-theme-accent-text-color);
        margin-bottom: 16px; 
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--tg-theme-section-separator-color);
      }

      button {
        background-color: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: var(--tg-theme-link-color);
      }

      .button-container {
        margin-top: 16px;
      }

      .bottom-menu {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--tg-theme-bottom-bar-bg-color);
        padding: 8px;
        display: flex;
        justify-content: space-around;
      }

      .bottom-menu button {
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
      }

      .profile-info {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
      }

      .profile-info img {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        margin-right: 16px;
      }

      .top-ups-list {
        margin-top: 16px;
      }

      .top-ups-list li {
        margin-bottom: 8px;
      }

      .earn-tasks li {
        margin-bottom: 16px;
        padding: 12px; 
        border-radius: 8px; 
        background-color: var(--tg-theme-secondary-bg-color); 
      }

      .airdrop-info {
        margin-top: 16px;
      }

      .custom-alert {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: var(--tg-theme-button-color);
        color: var(--tg-theme-button-text-color);
        padding: 8px 16px;
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
      }

      /* Styling for list items (mimicking the image style) */
      li {
        list-style-type: none; 
        padding: 10px 0;
        border-bottom: 1px solid var(--tg-theme-section-separator-color); 
      }

      /* Styling for invite friend section */
      .invite-section {
        text-align: center; 
      }

      .invite-section h2 {
        margin-bottom: 10px; 
      }

      .invite-bonus {
        background-color: var(--tg-theme-secondary-bg-color);
        padding: 15px;
        margin: 10px 0; 
        border-radius: 8px; 
      }
    </style>
</head>
<body>
    <div id="alert" class="custom-alert"></div>

    <div class="container" id="app">
      <div v-if="currentTab === 'rank'">
        <h1>StarGram Rank</h1>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="user in topUsers" :key="user.id">
              <td>{{ user.rank }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.balance }}</td>
            </tr>
          </tbody>
        </table>
        <div class="button-container">
          <button @click="topUp">Top Up</button>
        </div>
      </div>
  
      <div v-if="currentTab === 'friends'">
        <div class="invite-section">
          <h2>Invite friends</h2>
          <p>You and your friend will receive bonuses<br>for invitation. How it works?</p>
          <div class="invite-bonus">
            <p>Invite a friend <br>+750 to you and your friend</p>
          </div>
          <div class="invite-bonus">
            <p>Invite a friend with Telegram Premium <br> +1000 to you and your friend</p>
          </div>
          <button @click="inviteFriend">Invite Friend</button>
        </div>
        <div style="margin-top: 20px;">
          <h3>FRIENDS</h3>
          <p v-if="!invitedFriends.length">You haven't invited any friends yet</p>
          <ul v-else>
            <li v-for="friend in invitedFriends" :key="friend.id">{{ friend.name }}</li>
          </ul>
        </div>
      </div>
  
      <div v-if="currentTab === 'profile'">
        <h2>Profile</h2>
        <div class="profile-info">
          <img :src="user.photo_url" alt="Profile Photo">
          <div>
            <p>Name: {{ user.first_name }} {{ user.last_name }}</p>
            <p>Username: {{ user.username }}</p>
          </div>
        </div>
        <h3>Latest Top Ups</h3>
        <ul class="top-ups-list">
          <li v-for="topUp in topUps" :key="topUp.id">
            {{ topUp.amount }} XTR - {{ topUp.date }}
          </li>
        </ul>
      </div>
  
      <div v-if="currentTab === 'earn'">
        <h2>Earn stars</h2>
        <p>Simple steps to get more rating.</p>
        <h3>DAILY TASKS</h3>
        <ul class="earn-tasks">
          <li v-for="(task, index) in earnTasks" :key="index">
            <p style="color: var(--tg-theme-hint-color); font-size: 12px;">{{ task.description }}</p>
            <button @click="completeTask(task)">{{ task.name }}</button>
          </li>
        </ul>
      </div>
  
      <div v-if="currentTab === 'airdrop'">
        <h2>Airdrop</h2>
        <div class="airdrop-info">
          <p>1 balance â‰ˆ 10 tokens after Listing</p>
          <p>Estimated token price: $0.008</p>
        </div>
      </div>
    </div>
  
    <div class="bottom-menu">
      <button @click="switchTab('earn')">
        <img src="path_to_your_image.png" alt="Earn" height="24"> 
      </button>
      <button @click="switchTab('friends')">
        <img src="path_to_your_image.png" alt="Invite" height="24"> 
      </button>
      <button @click="switchTab('rank')">
        <img src="path_to_your_image.png" alt="Top" height="24"> 
      </button>
      <button @click="switchTab('profile')">
        <img src="path_to_your_image.png" alt="Profile" height="24"> 
      </button>
      <button @click="switchTab('airdrop')">
        <img src="path_to_your_image.png" alt="Wall" height="24"> 
      </button>
    </div>  

    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script>
        const KVSTORE_API_KEY = 'YOUR_KVSTORE_API_KEY'; 
        const TOP_USERS_LIMIT = 100;
    
        new Vue({
            el: '#app',
            data: {
                currentTab: 'rank',
                user: {},
                topUsers: [],
                topUps: [],
                balance: 0,
                referralLink: '',
                earnTasks: [
                    { name: 'Promote TON blockchain', stars: '+20,000', description: 'Ending soon' },
                    { name: 'Stars Purchase', stars: '+50,000', description: '' },
                    { name: 'Follow Major in Telegram', stars: '+1,250', description: '' },
                    { name: 'Share in Telegram Stories', stars: '+5,000', description: '' },
                    { name: 'TON Channels', stars: '+1,750', description: '' },
                    { name: 'Boost Major channel', stars: '+1,500', description: '' },
                    { name: 'Invite more Friends', stars: '+3,250', description: '' },
                    { name: 'Boost Roxman channel', stars: '+500', description: '' }
                ],
                invitedFriends: []
            },
            mounted() {
                this.initWebApp();
            },
            methods: {
                showAlert(text) {
                    const alertElement = document.getElementById('alert');
                    alertElement.style.display = 'flex';
                    alertElement.innerText = text;
                    setTimeout(() => {
                        alertElement.style.display = 'none';
                    }, 3000);
                },
                async initWebApp() {
                    try {
                        Telegram.WebApp.ready();
                        this.user = Telegram.WebApp.initDataUnsafe.user;
                        await this.loadData();
                        this.referralLink = `https://t.me/your_bot_username?start=${this.user.id}`;
                        setInterval(this.updateRank, 5000);
                        Telegram.WebApp.BackButton.show();
                        Telegram.WebApp.BackButton.onClick(() => {
                          if (this.currentTab !== 'rank') {
                            this.switchTab('rank'); 
                          } else {
                            Telegram.WebApp.close();
                          }
                        });
                    } catch (error) {
                        this.showAlert('Error initializing app!');
                    }
                },
                async loadData() {
                    try {
                        let userData = await KVStore.getItem(`user_${this.user.id}`);
                        if (userData) {
                            this.balance = userData.balance || 0;
                            this.topUps = userData.topUps || [];
                            this.invitedFriends = userData.invitedFriends || [];
                        } else {
                            await KVStore.setItem(`user_${this.user.id}`, { balance: 0, topUps: [], invitedFriends: [] });
                        }
                        await this.loadTopUsers();
                    } catch (error) {
                        this.showAlert('Error loading data!');
                    }
                },
                async loadTopUsers() {
                    try {
                        let topUsersData = await KVStore.list({ prefix: 'user_' });
                        this.topUsers = Object.entries(topUsersData)
                            .map(([key, value]) => ({
                                id: key.replace('user_', ''),
                                username: value.username || 'Unknown User',
                                balance: value.balance || 0
                            }))
                            .sort((a, b) => b.balance - a.balance)
                            .slice(0, TOP_USERS_LIMIT)
                            .map((user, index) => ({ ...user, rank: index + 1 }));
                    } catch (error) {
                        this.showAlert('Error loading top users!');
                    }
                },
                async updateRank() {
                    await this.loadTopUsers();
                },
                async topUp() {
                    try {
                        let amountXTR = Math.ceil((10000 - this.balance) / 100);
                        await Telegram.WebApp.openInvoice({
                          prices: [{ label: `${amountXTR} XTR`, amount: amountXTR * 100 }], 
                          provider_data: { "": "" }
                        });
                  
                        Telegram.WebApp.onEvent('invoiceClosed', async (event) => {
                          if (event.status === 'paid') {
                            this.balance += 10000; 
                            await KVStore.setItem(`user_${this.user.id}`, {
                              balance: this.balance,
                              topUps: [...this.topUps, { amount: amountXTR, date: new Date().toLocaleString() }]
                            });
                            await this.updateRank();
                          }
                        });
                      } catch (error) {
                        this.showAlert('Error during top-up! Make sure you have enough Stars to complete this purchase.');
                      }
                },
                inviteFriend() {
                    // Implementation for inviting friends (link sharing logic)
                    this.showAlert('Invite your friends!');
                },
                async completeTask(task) {
                    try {
                      this.balance += parseInt(task.stars.replace('+', '').replace(',', ''), 10);
                      await KVStore.setItem(`user_${this.user.id}`, { balance: this.balance });
                      await this.updateRank();
                      this.showAlert(`You earned ${task.stars} stars!`); 
                    } catch (error) {
                      this.showAlert('Error completing task!');
                    }
                  },
                switchTab(tabName) {
                    this.currentTab = tabName;
                }
            }
        });
    </script>
</body>
</html>
